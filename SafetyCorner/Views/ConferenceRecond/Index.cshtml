@using SafetyCorner.Common
<!-- TODO Bookstarp form-inline style 
http://getbootstrap.com/
calender(還是不行)
form style(font size)
-->
<script type="text/javascript">
    var app = angular.module('GridApp', ['ngGrid']);
    app.filter('bytes', function () {
        return function (bytes, precision) {
            if (isNaN(parseFloat(bytes)) || !isFinite(bytes)) return '-';
            if (typeof precision === 'undefined') precision = 1;
            var units = ['bytes', 'kB', 'MB', 'GB', 'TB', 'PB'],
			number = Math.floor(Math.log(bytes) / Math.log(1024));
            return (bytes / Math.pow(1024, Math.floor(number))).toFixed(precision) + ' ' + units[number];
        }
    });
    app.controller('FormCtrl', function ($scope, $http, $timeout) {
        //分頁
        $scope.pagingOptions = {
            pageSizes: [10, 25, 50],
            pageSize: 10,
            currentPage: 1
        }

        //監視分頁動作
        $scope.$watch('pagingOptions', function (newVal, oldVal) {
            //必需要換到不同頁
            if (newVal !== oldVal || newVal.currentPage !== oldVal.currentPage) {
                $scope.getPagedDataAsync(newVal.pageSize, newVal.currentPage)
            }
        }, true);

        //動態取資料
        $scope.getPagedDataAsync = function (pageSize, page, searchText) {
            setTimeout(function () {
                var queryData;
                queryData = { "fileDate": $('#datatimepicker_value').val(), "fileName": $scope.fileName };
                //TODO set query data
                $http.post('/ConferenceRecond/Query', queryData).success(function (largeLoad) {
                    $scope.setPagingData(largeLoad, page, pageSize);
                });
            }, 100);
        }

        //第一次取資料
        $scope.getPagedDataAsync($scope.pagingOptions.pageSize, $scope.pagingOptions.currentPage);

        //設定資料
        $scope.setPagingData = function (data, page, pageSize) {
            var pageData = data.slice((page - 1) * pageSize, page * pageSize);
            $scope.myData = pageData;
            $scope.totalServerItems = data.length;
            if (!$scope.$$phase) {
                $scope.$apply();
            }
        }

        $scope.search = function () {
            $scope.getPagedDataAsync($scope.pagingOptions.pageSize, $scope.pagingOptions.currentPage);
        }

        $scope.gridOptions = { data: 'myData',
            columnDefs: [{ field: 'Create_Date', width: '140px', displayName: '日期', cellTemplate: '<div class="ngCellText">{{row.getProperty(col.field)|date:\'yyyy-MM-dd\'}}</div>' }
			, { field: 'File_Size', width: '120px', displayName: '檔案大小', cellTemplate: '<div class="ngCellText">{{row.getProperty(col.field)|bytes}}</div>' }
			, { field: 'File_Name', displayName: '內容', cellTemplate: '<div class="ngCellText"><a href="{{row.getProperty(\'File_Root\')}}">{{row.getProperty(col.field)}}</a></div>'}],
            multiSelect: false,
            enablePaging: true,
            showFooter: true,
            enableRowSelection: false,
            i18n: "zh-tw",
            totalServerItems: 'totalServerItems',
            footerRowHeight: 50,
            pagingOptions: $scope.pagingOptions,
            afterSelectionChange: function (data) {
                if (typeof $scope.mySelections[0] !== "undefined") {
                    console.log("rowIndex", data.rowIndex);
                    console.log("selectName", $scope.mySelections[0].name)
                }
            }
        };
    })

  
</script>
<style type="text/css">
    .gridStyle
    {
        border: 1px solid rgb(212,212,212);
        width: 100%;
        height: 383px;
    }
    .btnFolder
    {
        background: url(../../Content/img/li_icon.png) left center no-repeat;
        padding-left: 20px;
        height: 25px;
    }
    
    .btn-file
    {
        position: relative;
        overflow: hidden;
    }
    .btn-file input[type=file]
    {
        position: absolute;
        top: 0;
        right: 0;
        min-width: 100%;
        min-height: 100%;
        font-size: 999px;
        text-align: right;
        filter: alpha(opacity=0);
        opacity: 0;
        background: red;
        cursor: inherit;
        display: block;
    }
    
    input[readonly]
    {
        background-color: white !important;
        cursor: text !important;
    }
    .modal label
    {
        color: Black;
        font-weight: 300;
    }
</style>
<h2>
    會議記錄</h2>
<hr />
@if (TempData["message"] != null)
{
    
    @TempData["message"]
   
}
<div id="FileUpload" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
    aria-hidden="true">
    <div class="modal-dialog ">
        <div class="modal-content">
            <div class="modal-header">
                上傳檔案
            </div>
            <!-- /modal-header -->
            @using (@Html.BeginForm("Upload", "ConferenceRecond", FormMethod.Post, new { enctype = "multipart/form-data" }))
            { 
                <div class="modal-body">
                    <div class="form-group">
                        <label class="col-sm-3">
                            檔案名稱：</label>
                        <div class="col-sm-7 file-control">
                            <div class="input-group">
                                <input type="text" class="form-control input-sm" readonly="">
                                <span class="input-group-btn"><span class="btn-primary btn-file btn btn-sm">請選擇
                                    <input name="file" id="file" type="file" multiple="">
                                </span></span>
                            </div>
                            <!-- /input-group -->
                        </div>
                        <!-- /file-control -->
                    </div>
                    <!-- /form-group -->
                </div> <!-- /modal-body -->
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">
                        上傳</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">
                        關閉</button>
                </div>
                <!-- /modal-footer -->
            }
        </div>
        <!-- /modal-content -->
    </div>
    <!-- /modal-dialog -->
</div>
<!-- /FileUpload -->
<div ng-app="GridApp">
    <div ng-controller="FormCtrl ">
        <div class="row form-group form-horizontal ">
            <label class="col-md-1 control-label">
                日期：</label>
            <div class="col-md-3">
                <div id="datetimepicker1" class="input-group">
                    <input id="datatimepicker_value" data-format="yyyy/MM/dd" type="text" class="form-control" />
                    <span class="input-group-btn">
                        <button type="button" class="btn btn-default add-on">
                            <span class=" glyphicon glyphicon-calendar"></span>
                        </button>
                    </span>
                </div>
            </div>
            <label class="col-md-1 control-label">
                內容：</label>
            <div class="col-md-3">
                <input type="text" ng-model="fileName" class="form-control" />
            </div>
            <div class="col-md-4">
                <button type="submit" class="btn btn-default" ng-click="search()">
                    查詢</button>
                <button type="button" class="btn btn-default" data-toggle="modal" data-target="#FileUpload">
                    上傳檔案</button>
            </div>
        </div>
        <div class="gridStyle" ng-grid="gridOptions">
        </div>
    </div>
</div>
<script type="text/javascript">
    $(document).on('change', '.btn-file :file', function () {
        var input = $(this), numFiles = input.get(0).files ? input.get(0).files.length
: 1, label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
        input.trigger('fileselect', [numFiles, label]);
    });

    $(document).ready(function () {
        $('.btn-file :file').on('fileselect', function (event, numFiles, label) {
            var input = $(this).parents('.file-control').find(':text'),
            log = numFiles > 1 ? numFiles + ' files selected' : label;
            if (input.length) { input.val(log); } else { if (log) alert(log); }
        });

        $('#datetimepicker1').datetimepicker({
            language: 'zh_tw'
        });
    }); </script>
