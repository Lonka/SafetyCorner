@using SafetyCorner.Common
<!-- TODO Bookstarp form-inline style 
http://getbootstrap.com/
calender
form style
-->
<script type="text/javascript">
    var app = angular.module('GridApp', ['ngGrid']);
    app.filter('bytes', function () {
        return function (bytes, precision) {
            if (isNaN(parseFloat(bytes)) || !isFinite(bytes)) return '-';
            if (typeof precision === 'undefined') precision = 1;
            var units = ['bytes', 'kB', 'MB', 'GB', 'TB', 'PB'],
			number = Math.floor(Math.log(bytes) / Math.log(1024));
            return (bytes / Math.pow(1024, Math.floor(number))).toFixed(precision) + ' ' + units[number];
        }
    });
    app.controller('FormCtrl', function ($scope, $http, $timeout) {
        //分頁
        $scope.pagingOptions = {
            pageSizes: [10, 25, 50],
            pageSize: 10,
            currentPage: 1
        }

        //監視分頁動作
        $scope.$watch('pagingOptions', function (newVal, oldVal) {
            //必需要換到不同頁
            if (newVal !== oldVal || newVal.currentPage !== oldVal.currentPage) {
                $scope.getPagedDataAsync(newVal.pageSize, newVal.currentPage)
            }
        }, true);

        //動態取資料
        $scope.getPagedDataAsync = function (pageSize, page, searchText) {
            setTimeout(function () {
                var queryData;
                queryData = { "fileDate": $scope.fileDate, "fileName": $scope.fileName };
                //TODO set query data
                $http.post('/ConferenceRecond/Query', queryData).success(function (largeLoad) {
                    $scope.setPagingData(largeLoad, page, pageSize);
                });
            }, 100);
        }

        //第一次取資料
        $scope.getPagedDataAsync($scope.pagingOptions.pageSize, $scope.pagingOptions.currentPage);

        //設定資料
        $scope.setPagingData = function (data, page, pageSize) {
            var pageData = data.slice((page - 1) * pageSize, page * pageSize);
            $scope.myData = pageData;
            $scope.totalServerItems = data.length;
            if (!$scope.$$phase) {
                $scope.$apply();
            }
        }

        $scope.search = function () {
            $scope.getPagedDataAsync($scope.pagingOptions.pageSize, $scope.pagingOptions.currentPage);
        }

        $scope.gridOptions = { data: 'myData',
            columnDefs: [{ field: 'Create_Date', width: '140px', displayName: '日期', cellTemplate: '<div class="ngCellText">{{row.getProperty(col.field)|date:\'yyyy-MM-dd\'}}</div>' }
			, { field: 'File_Size', width: '120px', displayName: '檔案大小', cellTemplate: '<div class="ngCellText">{{row.getProperty(col.field)|bytes}}</div>' }
			, { field: 'File_Name', displayName: '內容', cellTemplate: '<div class="ngCellText"><a href="{{row.getProperty(\'File_Root\')}}">{{row.getProperty(col.field)}}</a></div>'}],
            multiSelect: false,
            enablePaging: true,
            showFooter: true,
            enableRowSelection: false,
            i18n: "zh-tw",
            totalServerItems: 'totalServerItems',
            footerRowHeight: 50,
            pagingOptions: $scope.pagingOptions,
            afterSelectionChange: function (data) {
                if (typeof $scope.mySelections[0] !== "undefined") {
                    console.log("rowIndex", data.rowIndex);
                    console.log("selectName", $scope.mySelections[0].name)
                }
            }
        };
    })


    /*   angular.module('Calendar', ['ui.bootstrap']);
    var DatepickerDemoCtrl = function ($scope, $timeout) {
    $scope.today = function () {
    $scope.dt = new Date();
    };
    $scope.today();

    $scope.showWeeks = true;
    $scope.toggleWeeks = function () {
    $scope.showWeeks = !$scope.showWeeks;
    };

    $scope.clear = function () {
    $scope.dt = null;
    };

    // Disable weekend selection
    $scope.disabled = function (date, mode) {
    return (mode === 'day' && (date.getDay() === 0 || date.getDay() === 6));
    };

    $scope.toggleMin = function () {
    $scope.minDate = ($scope.minDate) ? null : new Date();
    };
    $scope.toggleMin();

    $scope.open = function () {
    $timeout(function () {
    $scope.opened = true;
    });
    };

    $scope.dateOptions = {
    'year-format': "'yy'",
    'starting-day': 1
    };
    };

    */
   
</script>
<style type="text/css">
    .btnFolder
    {
        background: url(../../Content/img/li_icon.png) left center no-repeat;
        padding-left: 20px;
        height: 25px;
    }
    
    .btn-file
    {
        position: relative;
        overflow: hidden;
    }
    .btn-file input[type=file]
    {
        position: absolute;
        top: 0;
        right: 0;
        min-width: 100%;
        min-height: 100%;
        font-size: 999px;
        text-align: right;
        filter: alpha(opacity=0);
        opacity: 0;
        background: red;
        cursor: inherit;
        display: block;
    }
    
    input[readonly]
    {
        background-color: white !important;
        cursor: text !important;
    }
    .modal label
    {
        color: Black;
        font-weight: 300;
    }
</style>
<h2>
    會議記錄</h2>
<hr />
<div id="FileUpload" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
    aria-hidden="true">
    <div class="modal-dialog ">
        <div class="modal-content">
            <div class="modal-header">
                上傳檔案
            </div>
            @using (@Html.BeginForm("Upload", "ConferenceRecond", FormMethod.Post, new { enctype = "multipart/form-data" }))
            { 
                <div class="modal-body">
                    <div class="form-group">
                        <label class="col-sm-3">
                            檔案名稱：</label>
                        <div class="col-sm-7 file-control">
                            <div class="input-group">
                                <input type="text" class="form-control input-sm" readonly="">
                                <span class="input-group-btn"><span class="btn-primary btn-file btn btn-sm">請選擇
                                    <input name="file" id="file" type="file" multiple="">
                                </span></span>
                            </div>
                            <!-- /input-group -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">
                        關閉</button>
                    <button type="submit" class="btn btn-primary">
                        上傳</button>
                </div>
            }
        </div>
    </div>
</div>
@*<div ng-app="Calendar">
    <div ng-controller="DatepickerDemoCtrl">
        <input type="text" ng-model="dt" datepicker-popup="dd-MMMM-yyyy" is-open="opened"
            min="minDate" max="'2015-06-22'" datepicker-options="dateOptions" date-disabled="disabled(date, mode)"
            ng-required="true" />
        <button class="btn" ng-click="open()">
            <i class="icon-calendar"></i>
        </button>
    </div>
</div>*@
<div ng-app="GridApp" class="form-inline">
    <div ng-controller="FormCtrl">
        <label>
            日期：</label>
        <input type="text" ng-model="fileDate" />
        <label>
            內容：</label>
        <input type="text" ng-model="fileName" />
        <button type="submit" ng-click="search()">
            查詢</button>
        <button type="button" data-toggle="modal" data-target="#FileUpload">
            上傳檔案</button>
        <div class="gridStyle" ng-grid="gridOptions">
        </div>
    </div>
</div>
<script type="text/javascript">
    $(document).on('change', '.btn-file :file', function () {
        var input = $(this),
            numFiles = input.get(0).files ? input.get(0).files.length : 1,
            label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
        input.trigger('fileselect', [numFiles, label]);
    });
    $(document).ready(function () {
        $('.btn-file :file').on('fileselect', function (event, numFiles, label) {

            var input = $(this).parents('.file-control').find(':text'),
					log = numFiles > 1 ? numFiles + ' files selected' : label;

            if (input.length) {
                input.val(log);
            } else {
                if (log) alert(log);
            }

        });
    });

</script>
